<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Document</title>
</head>
<style>
	#canvas{
		display: block;
		margin:20px auto;
		box-shadow: 1px 1px 3px #333;
	}
	#offcanvas{
		display: none;
	}
</style>
<body>
	<canvas id="canvas"></canvas>
	<canvas id="offcanvas"></canvas>
	<script>
	var can = document.getElementById("canvas");
	var ctx = can.getContext("2d");

	var offcanvas = document.getElementById("offcanvas");
	var offcontext = offcanvas.getContext("2d");
	var scale = 0;
	var img = new Image();
	var isMouseDown = false;
	window.onload = init();
	function init(){
		can.width = 230;
		can.height = 345;

		drawBg();
		drawImg();
	}
	function drawBg(){
		ctx.fillStyle = "#393550";
		ctx.fillRect(0,0,can.width,can.height);
	}
	function drawImg(){
		img.src = "img.jpg";
		img.onload = function(){
			ctx.drawImage(img,0,0,can.width,can.height);
			offcanvas.width = img.width;
			offcanvas.height = img.height;
			offcontext.drawImage(img,0,0);
			scale = offcanvas.width/can.width;
		}

	}
	function drawCanvasWithMagnifier(isShowMagnifier,point){
		ctx.clearRect(0,0,can.width,can.height);
		ctx.drawImage(img,0,0,can.width,can.height);
		if(isShowMagnifier){
			
			drawMagnifier(point);
		}
	}
	function drawMagnifier(point){
		var imageLG_cx = point.x*scale;
		var imageLG_cy = point.y*scale;
		var mr = 200;
		var sx = imageLG_cx - mr;
		var sy = imageLG_cy - mr;
		var dx = point.x - mr;
		var dy = point.y - mr;

		ctx.save();
		ctx.beginPath();
		ctx.arc(point.x,point.y,mr,0,Math.PI*2,true);
		ctx.closePath();

		ctx.lineWidth = 5;
		ctx.clip();
		sx = sx<0?0:sx;
		sy = sy<0?0:sy;
		dx = dx<0?0:dx;
		dy = dy<0?0:dy;
		ctx.drawImage(offcanvas,sx,sy,2*mr,2*mr,dx,dy,2*mr,2*mr);
		ctx.strokeStyle = "red";
		ctx.stroke();
		console.log(sx,sy,dx,dy);
		ctx.restore();
	}
	canvas.onmousedown = function(e){
		e.preventDefault();
		var point = windowToCanvas(e.clientX,e.clientY);
		console.log(point.x,point.y);
		isMouseDown = true;
		drawCanvasWithMagnifier(isMouseDown,point);
	}
	
	canvas.onmousemove = function(e){
		ctx.clearRect(0,0,can.width,can.height);
		ctx.drawImage(img,0,0,can.width,can.height);
		e.preventDefault();
		var point = windowToCanvas(e.clientX,e.clientY);
		if(isMouseDown == true){
			var point = windowToCanvas(e.clientX,e.clientY);
			console.log(point.x,point.y);
		}
		drawCanvasWithMagnifier(isMouseDown,point);

	}
	canvas.onmouseup = function(e){
		var point = windowToCanvas(e.clientX,e.clientY);
		e.preventDefault();

		isMouseDown = false;
		drawCanvasWithMagnifier(isMouseDown,point);
		
	}
	canvas.onmouseout = function(e){
		var point = windowToCanvas(e.clientX,e.clientY);

		e.preventDefault();
		isMouseDown = false;
		drawCanvasWithMagnifier(isMouseDown,point);

		
	}
	function windowToCanvas(x,y){
		var bbox = canvas.getBoundingClientRect();
		return{
			x:x-bbox.left,
			y:y-bbox.top
		}
	}
	</script>
</body>
</html>